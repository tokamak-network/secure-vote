# Secure Vote - Web Interface

A Next.js web interface for testing the threshold cryptography voting system with MetaMask.

## Features

- **Automated Demo Setup**: One-click setup that generates threshold keys, creates proposals, and submits dummy votes
- **MetaMask Integration**: Vote using your own wallet while other roles are automated
- **Threshold Decryption**: Committee automatically decrypts and tallies votes off-chain
- **Results Visualization**: View final tallies with cryptographic verification details

## Prerequisites

1. **Anvil** (local Ethereum node) running
2. **Contract deployed** to Anvil
3. **MetaMask** browser extension installed
4. **Foundry** test account imported to MetaMask

## Setup Instructions

### 1. Install Dependencies

```bash
cd frontend
npm install
```

### 2. Start Anvil

In a separate terminal:

```bash
cd ..
anvil
```

Keep this running. Anvil will provide 10 test accounts with 10,000 ETH each.

### 3. Deploy Contract

In another terminal:

```bash
cd ..
forge script script/Deploy.s.sol --rpc-url http://127.0.0.1:8545 --broadcast --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
```

Copy the deployed `SecureVoting` contract address from the output.

### 4. Configure Environment

Create `.env.local`:

```bash
cp .env.example .env.local
```

Edit `.env.local` and paste your contract address:

```
NEXT_PUBLIC_CONTRACT_ADDRESS=0x5FbDB2315678afecb367f032d93F642f64180aa3
```

### 5. Setup MetaMask

#### Add Anvil Network

1. Open MetaMask
2. Click network dropdown → "Add Network" → "Add a network manually"
3. Enter:
   - **Network name:** Anvil
   - **RPC URL:** http://127.0.0.1:8545
   - **Chain ID:** 31337
   - **Currency symbol:** ETH
4. Save

#### Import Test Account

Import Foundry test account #3 (this will be your voter account):

1. Click account icon → "Import Account"
2. Select "Private Key"
3. Paste: `0x7c852118294e51e653712a81e05800f419141751be58f605c371e15141b007a6`
4. Click "Import"

**WARNING:** This is a publicly known test key. NEVER use it on mainnet or with real funds.

### 6. Start Development Server

```bash
npm run dev
```

Open http://localhost:3000

## Usage Flow

### Step 1: Setup Demo

1. On the home page, click **"Setup Demo"**
2. This will:
   - Generate a threshold key (3-of-5)
   - Store key shares on the backend
   - Deposit bond (10 ETH from account 0)
   - Create a sample proposal: "Should we upgrade the protocol?"
   - Submit 2 dummy votes:
     - Account 1: Yes
     - Account 2: No

### Step 2: Connect Wallet & Vote

1. Click **"Connect Wallet"** in the top right
2. Select the imported Foundry account
3. Approve the connection
4. Click **"Vote"** on the proposal
5. Choose **"Yes"** or **"No"**
6. Your vote is encrypted in the browser before submission
7. Approve the MetaMask transaction

### Step 3: Decrypt & Tally

1. Go to the **"Committee"** page (top navigation)
2. Click **"Decrypt & Tally"**
3. The backend will:
   - Fetch all encrypted votes from the contract
   - Decrypt them using threshold cryptography (3-of-5 shares)
   - Aggregate the results
   - Generate a Merkle root
   - Submit the tally to the blockchain

### Step 4: View Results

1. You'll be redirected to the **Results** page automatically
2. View:
   - Final vote counts (Yes/No)
   - Percentage breakdown
   - Outcome (Passed/Rejected/Tied)
   - Merkle root for verification
   - Submitter address and timestamp

## Architecture

### Frontend (Browser)
- **Pages:** Home, Vote, Committee, Results
- **Wallet:** MetaMask (via RainbowKit + wagmi)
- **Encryption:** Uses offchain library in browser (vote encryption only)

### Backend (API Routes)
- **`/api/setup-demo`:** Automated demo setup with dummy votes
- **`/api/decrypt-tally`:** Threshold decryption and tally submission
- **Storage:** Key shares stored in `key-shares.json` (file-based)

### On-Chain (Solidity)
- **SecureVoting.sol:** Proposal management, vote commitments, tally verification
- **Events:** VoteCommitted (used to fetch votes for decryption)

## Key Files

```
frontend/
├── pages/
│   ├── index.tsx              # Home page (proposal list)
│   ├── vote/[id].tsx          # Vote page (MetaMask signing)
│   ├── committee.tsx          # Committee dashboard
│   ├── results/[id].tsx       # Results visualization
│   └── api/
│       ├── setup-demo.ts      # Backend: demo setup
│       └── decrypt-tally.ts   # Backend: decryption
├── components/
│   └── Layout.tsx             # Navigation + wallet connect
├── lib/
│   ├── contracts.ts           # ABI + contract address
│   ├── crypto-wrapper.ts      # Offchain library imports
│   ├── anvil-helpers.ts       # Foundry account utilities
│   └── wagmi-config.ts        # Wagmi configuration
└── key-shares.json            # Generated by setup-demo (gitignored)
```

## Troubleshooting

### "Contract address not set"
- Make sure `.env.local` exists with `NEXT_PUBLIC_CONTRACT_ADDRESS`
- Restart the dev server after creating `.env.local`

### "Key shares not found"
- Click "Setup Demo" first
- Check that `key-shares.json` was created in the frontend directory

### "Transaction failed"
- Make sure Anvil is running
- Verify the contract address is correct
- Check MetaMask is connected to Anvil network (chainId 31337)

### "Insufficient funds"
- The imported account should have 10,000 ETH from Anvil
- Try restarting Anvil (it resets balances)

### "RPC not responding"
- Verify Anvil is running on http://127.0.0.1:8545
- Check no firewall is blocking port 8545

## Development

### Build for Production

```bash
npm run build
npm start
```

### Lint

```bash
npm run lint
```

## Security Notes

- **Test Environment Only:** This setup uses publicly known private keys
- **No Authentication:** Anyone can access the API routes (fine for local testing)
- **File Storage:** Key shares stored in a file (use Redis/database for production)
- **No Challenge Mechanism:** The frontend doesn't implement tally challenges (available in contract)

## Next Steps

- Add Merkle proof verification UI
- Implement tally challenge mechanism
- Add proper key management (encrypted storage)
- Deploy to testnet with real wallets
- Add authentication for committee members

## License

MIT
